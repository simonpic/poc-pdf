#!/bin/sh
# Maven Wrapper script - downloads and runs Maven
set -e

MAVEN_PROJECTBASEDIR="${MAVEN_BASEDIR:-$(cd "$(dirname "$0")" && pwd)}"
MAVEN_USER_HOME="${MAVEN_USER_HOME:-$HOME/.m2}"
WRAPPER_PROPERTIES="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.properties"

if [ -f "$WRAPPER_PROPERTIES" ]; then
    DIST_URL=$(grep 'distributionUrl' "$WRAPPER_PROPERTIES" | cut -d'=' -f2-)
    DIST_NAME=$(basename "$DIST_URL" .zip)
    DIST_DIR="$MAVEN_USER_HOME/wrapper/dists/$DIST_NAME"

    if [ -d "$DIST_DIR" ]; then
        MAVEN_HOME=$(find "$DIST_DIR" -maxdepth 2 -name "bin" -type d 2>/dev/null | head -1 | xargs dirname)
    fi

    if [ -z "$MAVEN_HOME" ] || [ ! -f "$MAVEN_HOME/bin/mvn" ]; then
        echo "Downloading Maven from $DIST_URL..."
        mkdir -p "$DIST_DIR"
        curl -fsSL "$DIST_URL" -o "$DIST_DIR/maven.zip"
        unzip -qo "$DIST_DIR/maven.zip" -d "$DIST_DIR"
        rm -f "$DIST_DIR/maven.zip"
        MAVEN_HOME=$(find "$DIST_DIR" -maxdepth 2 -name "bin" -type d 2>/dev/null | head -1 | xargs dirname)
    fi
fi

exec "$MAVEN_HOME/bin/mvn" "$@"
